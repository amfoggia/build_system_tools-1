## How to handle integration tests

To test our program, we changed the behavior of the main and now it reads 2 arguments from an input file. We write a custom bash script used to test the results generated by our code with respect to a reference.

```bash
$ tree -I "*md" 
.
├── CMakeLists.txt
├── include
│   └── constants.h
├── main.cc
├── meson.build
├── src
│   ├── CMakeLists.txt
│   ├── mathematics
│   │   ├── CMakeLists.txt
│   │   ├── mathematics.cc
│   │   ├── mathematics.h
│   │   └── meson.build
│   ├── meson.build
│   └── physics
│       ├── CMakeLists.txt
│       ├── meson.build
│       ├── physics.cc
│       └── physics.h
└── tests
    ├── CMakeLists.txt
    ├── integration_tests
    │   ├── 01.input
    │   ├── 01.output
    │   ├── 02.input
    │   ├── 02.output
    │   ├── CMakeLists.txt
    │   ├── compare.sh
    │   └── meson.build
    └── meson.build

```

### CMake

- Create a file `CMakeLists.txt` (case sensitive) with proper commands
- Create a build directory and `cd` in it (e.g. `mkdir build_cmake && cd build_cmake`)
- Run `cmake /path/to/CMakeLists.txt` (e.g. `cmake ..`) 
- Compile with `make`
- Run the tests with `ctest`

##### CMake useful commands

```cmake
enable_testing() # it must be in the root CMakeLists.txt

add_test(NAME test_name
         COMMAND exe all the needed input
         WORKING_DIRECTORY /path/to/a/dir)
```

For example, to run our executable `exe` with input file `01.input` and compare the output with `01.outpu` using `compare.sh` we can do as follows

```cmake
set(_prefix ${CMAKE_CURRENT_SOURCE_DIR})

add_test(NAME "01_run_and_diff"
  COMMAND ${_prefix}/compare.sh ${CMAKE_BINARY_DIR}/exe
  ${_prefix}/01.output ${_prefix}/01.input
  WORKDIR ${CMAKE_BINARY_DIR})

```

 

### Meson

- Create a file `meson.build` with proper commands

- Populate the build directory and go there

  - you can ask to meson to create it 

    ```bash
    meson build_meson && cd build_meson
    ```

  - or you create it and call meson from there `mkdir build_meson && cd build_meson`

    ```bash
    mkdir build_meson && cd build_meson && meson ..
    ```

- Compile with `ninja`

- Run the tests with `meson test` or `ninja test`

##### Meson useful commands

```cmake
test('test_name', exe, 
      args:['all', 'the',
       'needed', 'arguments'],
       workdir: meson.current_source_dir())
```

where `exe` is an executable or the object returned by `find_program()`

```cmake
compare = find_program('compare.sh')

test('test_name', compare, ...)
```


